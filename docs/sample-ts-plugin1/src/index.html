<!DOCTYPE html>

<html>
<head>
  <title>index.ts</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.ts</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Extract interface from a class declaration. Write it just before the class declaration and make the class implement it. Only members with “public” modifier will be extracted</p>
<p><strong>Screencast</strong>: </p>
<p><img src="../plugin-screencast.gif" alt="See it in action"></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> ts_module <span class="hljs-keyword">from</span> <span class="hljs-string">'../node_modules/typescript/lib/tsserverlibrary'</span>
<span class="hljs-keyword">import</span> { findChildContainingPosition, findParent, positionOrRangeToNumber, positionOrRangeToRange, findParentFromPosition, dumpAst } <span class="hljs-keyword">from</span> <span class="hljs-string">'typescript-ast-util'</span>
<span class="hljs-keyword">import</span> { extractInterface } <span class="hljs-keyword">from</span> <span class="hljs-string">'./extract-interface'</span>

<span class="hljs-keyword">const</span> PLUGIN_NAME = <span class="hljs-string">'typescript-plugin-extract-interface'</span>
<span class="hljs-keyword">const</span> REFACTOR_ACTION_NAME = <span class="hljs-string">`<span class="hljs-subst">${PLUGIN_NAME}</span>-refactor-action`</span>
<span class="hljs-keyword">let</span> ts: <span class="hljs-keyword">typeof</span> ts_module
<span class="hljs-keyword">let</span> info: ts_<span class="hljs-built_in">module</span>.server.PluginCreateInfo

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params">modules: { typescript: <span class="hljs-keyword">typeof</span> ts_module }</span>) </span>{

  ts = modules.typescript

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params">anInfo: ts_module.server.PluginCreateInfo</span>) </span>{
    info = anInfo
    info.project.projectService.logger.info(<span class="hljs-string">`<span class="hljs-subst">${PLUGIN_NAME}</span> created`</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>initialize proxy </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> proxy: ts.LanguageService = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k of <span class="hljs-built_in">Object</span>.keys(info.languageService) <span class="hljs-keyword">as</span> <span class="hljs-built_in">Array</span>&lt;keyof ts.LanguageService&gt;) {
      <span class="hljs-keyword">const</span> x = info.languageService[k]
      proxy[k] = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">Array</span>&lt;{}&gt;</span>) =&gt;</span> x.apply(info.languageService, args)
    }

    proxy.getApplicableRefactors = getApplicableRefactors
    proxy.getEditsForRefactor = getEditsForRefactor

    <span class="hljs-keyword">return</span> proxy
  }

  <span class="hljs-keyword">return</span> { create }
}

<span class="hljs-keyword">export</span> = init


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getApplicableRefactors</span>(<span class="hljs-params">fileName: <span class="hljs-built_in">string</span>, positionOrRange: <span class="hljs-built_in">number</span> | ts.TextRange</span>): <span class="hljs-title">ts_module</span>.<span class="hljs-title">ApplicableRefactorInfo</span>[] </span>{
  <span class="hljs-keyword">const</span> refactors = info.languageService.getApplicableRefactors(fileName, positionOrRange) || []
  <span class="hljs-keyword">const</span> targetNode = findParentFromPosition(info, fileName, positionOrRange, <span class="hljs-function"><span class="hljs-params">parent</span> =&gt;</span> parent.kind === ts.SyntaxKind.ClassDeclaration)
  <span class="hljs-keyword">if</span> (!targetNode) {
    <span class="hljs-keyword">return</span> refactors
  }
  <span class="hljs-keyword">const</span> refactorInfo: ts_<span class="hljs-built_in">module</span>.ApplicableRefactorInfo = {
    name: <span class="hljs-string">`<span class="hljs-subst">${PLUGIN_NAME}</span>-refactor-info`</span>,
    description: <span class="hljs-string">'Extract interface'</span>,
    actions: [

      { name: REFACTOR_ACTION_NAME, description: <span class="hljs-string">'Extract interface'</span> },
      { name: <span class="hljs-string">'print-ast'</span>, description: <span class="hljs-string">'Print AST'</span> }<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> remove print ast to its own project</span>
    ],
  }
  refactors.push(refactorInfo)
  <span class="hljs-keyword">return</span> refactors
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEditsForRefactor</span>(<span class="hljs-params">fileName: <span class="hljs-built_in">string</span>, formatOptions: ts.FormatCodeSettings,
  positionOrRange: <span class="hljs-built_in">number</span> | ts_module.TextRange, refactorName: <span class="hljs-built_in">string</span>,
  actionName: <span class="hljs-built_in">string</span></span>): <span class="hljs-title">ts</span>.<span class="hljs-title">RefactorEditInfo</span> | <span class="hljs-title">undefined</span> </span>{
  <span class="hljs-keyword">let</span> targetNode, newText

  <span class="hljs-keyword">if</span> (actionName == REFACTOR_ACTION_NAME) {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>find the first parent that is a class declaration starting from given position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    targetNode = findParentFromPosition(info, fileName, positionOrRange, 
      <span class="hljs-function"><span class="hljs-params">parent</span> =&gt;</span> parent.kind === ts.SyntaxKind.ClassDeclaration)
    newText = extractInterface(targetNode <span class="hljs-keyword">as</span> ts_<span class="hljs-built_in">module</span>.ClassDeclaration)
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (actionName == <span class="hljs-string">'print-ast'</span>) { <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> remove print ast to its own project</span>
    targetNode = findParentFromPosition(info, fileName, positionOrRange, <span class="hljs-function"><span class="hljs-params">parent</span> =&gt;</span> <span class="hljs-literal">true</span>)
    newText = <span class="hljs-string">'\n`'</span>+dumpAst(targetNode)+<span class="hljs-string">'`\n'</span>
  }

  <span class="hljs-keyword">if</span> (targetNode &amp;&amp; newText) {
    <span class="hljs-keyword">return</span> {
      edits: [{
        fileName,
        textChanges: [{
          span: { start: targetNode.getEnd(), length: targetNode.getEnd() }, <span class="hljs-comment">// add it right after the class decl</span>
          newText: newText
        }],
      }],
      renameFilename: <span class="hljs-literal">undefined</span>,
      renameLocation: <span class="hljs-literal">undefined</span>,
    }
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> info.languageService.getEditsForRefactor(fileName, formatOptions, positionOrRange, refactorName, actionName)
  }

}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
